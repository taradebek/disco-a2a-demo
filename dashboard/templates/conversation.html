<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A2A Agent Conversation Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{
            --brand-bg:#0b1020;           /* deep navy background */
            --brand-surface:#11162a;      /* dark surface */
            --brand-card:#151b31;         /* card base */
            --brand-text:#e6e8f0;         /* primary text */
            --brand-muted:#9aa3b2;        /* muted text */
            --brand-primary:#00e3a2;      /* Disco emerald */
            --brand-primary-700:#00c58d;
            --brand-accent:#6c5ce7;       /* purple accent */
            --brand-warning:#ffc107;
            --brand-danger:#ff5c69;
            --border:#1f2745;
            --shadow:0 10px 30px rgba(0,0,0,0.2625);
        }
        body{background:linear-gradient(180deg,var(--brand-bg),#0e1430);color:var(--brand-text);font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;}
        .navbar-branding{position:sticky;top:0;z-index:1040;background:rgba(11,16,32,0.85);backdrop-filter:saturate(180%) blur(10px);border-bottom:1px solid var(--border);} 
        .navbar-branding .brand-badge{display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border-radius:999px;background:linear-gradient(135deg,rgba(0,227,162,0.15),rgba(108,92,231,0.15));border:1px solid rgba(255,255,255,0.08);} 
        .navbar-branding .brand-dot{width:10px;height:10px;border-radius:50%;background:var(--brand-primary);box-shadow:0 0 9px var(--brand-primary);} 
        .navbar-branding .brand-name{font-weight:700;letter-spacing:0.3px;color:var(--brand-text);} 
        .navbar-branding .brand-tag{color:var(--brand-muted);font-weight:500;}

        .agent-panel {min-height: 500px;border: 1px solid var(--border);border-radius: 16px;background: linear-gradient(180deg, var(--brand-card) 0%, var(--brand-surface) 100%);box-shadow: var(--shadow);} 
        .agent-header {background: linear-gradient(135deg, rgba(0,227,162,0.12) 0%, rgba(108,92,231,0.12) 100%);color: var(--brand-text);padding: 16px;border-radius: 16px 16px 0 0;border-bottom:1px solid var(--border);} 
        .agent-header.supplier {background: linear-gradient(135deg, rgba(108,92,231,0.16) 0%, rgba(0,227,162,0.12) 100%);} 
        .conversation-area {height: 400px;overflow-y: auto;padding: 20px;background: #0f1530;border-radius: 0 0 16px 16px;} 
        .message {margin-bottom: 14px;animation: slideIn 0.5s ease-out;} 
        .message-bubble {padding: 12px 16px;border-radius: 14px;max-width: 82%;word-wrap: break-word;position: relative;border:1px solid var(--border);background: #0c1230;color:var(--brand-text);} 
        .message.sent {text-align: right;} 
        .message.sent .message-bubble {background: linear-gradient(135deg, rgba(0,227,162,0.18), rgba(0,227,162,0.10));border-color: rgba(0,227,162,0.1875);} 
        .message.received {text-align: left;} 
        .message.received .message-bubble {background: linear-gradient(135deg, rgba(108,92,231,0.18), rgba(108,92,231,0.10));border-color: rgba(108,92,231,0.1875);} 
        .agent-status {display: inline-block;padding: 4px 12px;border-radius: 999px;font-size: 0.75em;font-weight: 600;border:1px solid var(--border);} 
        .status-active {background: rgba(0,227,162,0.15);color: var(--brand-primary);} 
        .status-thinking {background: rgba(255,193,7,0.12);color: var(--brand-warning);} 
        .status-error {background: rgba(255,92,105,0.12);color: var(--brand-danger);} 
        .capability-badge {font-size: 0.7em;margin: 2px;border:1px solid var(--border);background:#0f1738;color:var(--brand-muted);} 
        .step-description {background: linear-gradient(180deg, rgba(0,227,162,0.10), rgba(108,92,231,0.10));padding: 15px;border-radius: 10px;margin: 10px 0;border:1px solid var(--border);} 
        .scenario-description {background: #0f1633;padding: 24px;border-radius: 14px;margin: 24px 0;text-align: center;border: 1px solid var(--border);} 

        .main-cta {background: linear-gradient(135deg, var(--brand-primary) 0%, var(--brand-primary-700) 100%);border: none;color: #08111f;font-weight:700;letter-spacing:.3px;font-size: 1.0em;padding: 14px 26px;border-radius: 14px;box-shadow: 0 10px 25px rgba(0,227,162,0.1875);transition: all 0.25s ease;} 
        .main-cta:hover {transform: translateY(-2px);box-shadow: 0 14px 28px rgba(0,227,162,0.2625);color:#06101d;} 
        .main-cta:active {transform: translateY(0);} 
        .btn-outline-secondary {border-color: var(--border);color: var(--brand-muted);background: #0f1738;} 
        .btn-outline-secondary:hover{color:var(--brand-text);}

        .product-item {background: rgba(0,227,162,0.12);padding: 4px 8px;border-radius: 6px;margin: 2px 0;font-weight: 500;display: inline-block;border:1px solid rgba(0,227,162,0.25);} 
        .message.received .product-item {background: rgba(108,92,231,0.14);color: #dfe3ff;border:1px solid rgba(108,92,231,0.25);} 
        .inventory-item {background: #0f2240;color: #bfe9ff;padding: 6px 10px;border-radius: 6px;margin: 3px 0;display: block;border-left: 3px solid #17a2b8;} 
        .order-item {background: rgba(0,227,162,0.12);color: var(--brand-text);padding: 6px 10px;border-radius: 6px;margin: 3px 0;display: block;border-left: 3px solid var(--brand-primary);} 
        .invoice-item {background: rgba(255,92,105,0.10);color: #ffdadd;padding: 6px 10px;border-radius: 6px;margin: 3px 0;display: block;border-left: 3px solid var(--brand-danger);} 
        .low-stock-item {background: rgba(255,92,105,0.12);color: #ffb3bb;padding: 6px 10px;border-radius: 6px;margin: 3px 0;display: block;border-left: 3px solid var(--brand-danger);animation: pulse 2s infinite;} 
        @keyframes pulse {0% { opacity: 1;}50% { opacity: 0.7;}100% { opacity: 1;}}
        
        .floating-cta {position: fixed;bottom: 24px;right: 24px;z-index: 1000;background: rgba(15,22,51,0.9);padding: 12px 14px;border-radius: 16px;box-shadow: var(--shadow);border: 1px solid var(--border);transition: all 0.3s ease;display: flex;flex-direction: column;gap: 8px;align-items: center;} 
        .floating-cta .main-cta {font-size: 0.95em;padding: 12px 18px;} 

        .scroll-to-top {position: fixed;bottom: 24px;left: 24px;z-index: 1000;background: var(--brand-accent);color: white;border: none;border-radius: 12px;width: 46px;height: 46px;font-size: 1.0em;box-shadow: 0 8px 20px rgba(108,92,231,0.2625);transition: all 0.3s ease;opacity: 0;pointer-events: none;} 
        .scroll-to-top.show {opacity: 1;pointer-events: auto;} 
        .scroll-to-top:hover {transform: translateY(-2px);} 
        
        .container-fluid {padding-bottom: 120px;}
        .debug-info {position: fixed;top: 10px;right: 10px;background: rgba(0,0,0,0.6);color: white;padding: 10px;border-radius: 8px;font-size: 12px;z-index: 1001;max-width: 200px;}
        .low-stock-alert {background: linear-gradient(135deg, rgba(255,92,105,0.2) 0%, rgba(255,92,105,0.12) 100%);color: white;padding: 15px;border-radius: 10px;margin: 15px 0;text-align: center;animation: pulse 2s infinite;box-shadow: 0 4px 15px rgba(220, 53, 69, 0.1875);}

        .book-call-btn {
            background: linear-gradient(135deg, var(--brand-primary) 0%, var(--brand-primary-700) 100%);
            color: #08111f !important;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 8px;
            text-decoration: none !important;
            font-size: 0.9em;
            border: 1px solid rgba(0,227,162,0.3);
            box-shadow: 0 4px 12px rgba(0,227,162,0.2);
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .book-call-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,227,162,0.3);
            color: #06101d !important;
        }
        .book-call-btn:active {
            transform: translateY(0);
        }
        .book-call-btn i {
            font-size: 0.8em;
        }
 
    </style>
</head>
<body>
    <!-- Branded Navbar/Header -->
    <div class="navbar-branding">
        <div class="container-fluid py-3">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-2 brand-badge">
                    <span class="brand-dot"></span>
                    <span class="brand-name">Disco</span>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <a href="https://calendly.com/tara-paywithdisco/30min" target="_blank" rel="noopener" class="book-call-btn">
                        <i class="fas fa-calendar-alt"></i>
                        Book a call
                    </a>
                    <div class="brand-tag small">Enterprise-grade agent-to-agent payments</div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Scenario Description -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="scenario-description">
                    <h5 class="mb-2">
                        <i class="fas fa-play-circle me-2" style="color:var(--brand-primary)"></i>
                        Office Supplies Purchase Scenario
                    </h5>
                    <p class="mb-0" style="color:var(--brand-muted)">
                        Watch two AI agents collaborate to purchase office supplies using Disco.<br>
                        The scenario runs with 3-second delays between each step so you can follow along.
                    </p>
                </div>
            </div>
        </div>

        <!-- Current Step Description -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="step-description" id="current-step-description">
                    <h6 class="mb-2">
                        <i class="fas fa-info-circle me-2" style="color:var(--brand-accent)"></i>
                        Current Step
                    </h6>
                    <p class="mb-0" id="step-text">Ready to start the demo. Click the floating "Trigger Scenario" button to begin watching the agents interact!</p>
                </div>
            </div>
        </div>

        <!-- Agent Panels -->
        <div class="row" id="agent-panels">
            <!-- Procurement Agent -->
            <div class="col-md-6">
                <div class="agent-panel">
                    <div class="agent-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-1">
                                    <i class="fas fa-shopping-cart me-2" style="color:var(--brand-primary)"></i>
                                    Procurement Agent
                                </h5>
                                <small style="color:var(--brand-muted)">Handles purchase requests and negotiations</small>
                            </div>
                            <span class="agent-status status-active" id="proc-status">Ready</span>
                        </div>
                        <div class="mt-2">
                            <span class="badge bg-light text-dark capability-badge">Monitor Inventory</span>
                            <span class="badge bg-light text-dark capability-badge">Create Purchase Request</span>
                            <span class="badge bg-light text-dark capability-badge">Evaluate Quotes</span>
                            <span class="badge bg-light text-dark capability-badge">Place Orders</span>
                        </div>
                    </div>
                    <div class="conversation-area" id="procurement-conversation">
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-robot fa-3x mb-3"></i>
                            <p>Waiting for conversation to start...</p>
                        </div>
                    </div>
                    <div class="typing-indicator" id="procurement-typing">
                        <i class="fas fa-circle-notch fa-spin me-2"></i>
                        Procurement Agent is thinking...
                    </div>
                </div>
            </div>

            <!-- Supplier Agent -->
            <div class="col-md-6">
                <div class="agent-panel">
                    <div class="agent-header supplier">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-1">
                                    <i class="fas fa-warehouse me-2" style="color:var(--brand-accent)"></i>
                                    Supplier Agent
                                </h5>
                                <small style="color:var(--brand-muted)">Manages inventory and generates quotes</small>
                            </div>
                            <span class="agent-status status-active" id="supp-status">Ready</span>
                        </div>
                        <div class="mt-2">
                            <span class="badge bg-light text-dark capability-badge">Check Inventory</span>
                            <span class="badge bg-light text-dark capability-badge">Generate Quotes</span>
                            <span class="badge bg-light text-dark capability-badge">Process Orders</span>
                        </div>
                    </div>
                    <div class="conversation-area" id="supplier-conversation">
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-robot fa-3x mb-3"></i>
                            <p>Waiting for conversation to start...</p>
                        </div>
                    </div>
                    <div class="typing-indicator" id="supplier-typing">
                        <i class="fas fa-circle-notch fa-spin me-2"></i>
                        Supplier Agent is thinking...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Action Button - Bottom Right -->
    <div class="floating-cta" id="floating-cta">
        <button class="btn main-cta" onclick="startSlowDemo()" id="floating-main-btn">
            <i class="fas fa-play me-2"></i>Trigger Scenario
        </button>
        <button class="btn btn-outline-secondary btn-sm" onclick="clearConversation()">
            <i class="fas fa-trash me-2"></i>Clear
        </button>
    </div>

    <!-- Scroll to Top Button - Bottom Left -->
    <button class="scroll-to-top" onclick="scrollToAgents()" id="scroll-to-top">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- Debug Info -->
    <div class="debug-info" id="debug-info">
        <div>Steps: <span id="debug-steps">0</span></div>
        <div>Demo Running: <span id="debug-demo">false</span></div>
        <div>Invoice Downloaded: <span id="debug-invoice">false</span></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let ws = null;
        let currentStep = 0;
        let messageCount = 0;
        let isDemoRunning = false;
        let invoiceDownloaded = false; // Track if invoice has been downloaded
        let demoStepCount = 0; // Track demo steps
        let currentDemoStepCount = 0; // Track steps in current demo only

        // Office supplies with inventory levels
        const officeSupplies = [
            { name: "A4 White Copy Paper", quantity: "5 reams", description: "500 sheets each", price: 24.99, inStock: 12, unit: "reams" },
            { name: "Blue Ballpoint Pens", quantity: "2 boxes", description: "12 pens per box", price: 8.50, inStock: 25, unit: "boxes" },
            { name: "Heavy-Duty Stapler", quantity: "1 unit", description: "with 1000 staples", price: 15.75, inStock: 8, unit: "units" },
            { name: "Manila File Folders", quantity: "3 packs", description: "100 folders per pack", price: 12.30, inStock: 15, unit: "packs" },
            { name: "Clear Packing Tape", quantity: "2 rolls", description: "standard size", price: 6.25, inStock: 30, unit: "rolls" }
        ];

        // Current inventory levels (will be reduced to simulate low stock)
        let currentInventory = [
            { name: "A4 White Copy Paper", currentStock: 2, minThreshold: 5, unit: "reams" },
            { name: "Blue Ballpoint Pens", currentStock: 1, minThreshold: 3, unit: "boxes" },
            { name: "Heavy-Duty Stapler", currentStock: 0, minThreshold: 2, unit: "units" },
            { name: "Manila File Folders", currentStock: 1, minThreshold: 4, unit: "packs" },
            { name: "Clear Packing Tape", currentStock: 8, minThreshold: 10, unit: "rolls" }
        ];

        function updateDebugInfo() {
            document.getElementById('debug-steps').textContent = currentDemoStepCount;
            document.getElementById('debug-demo').textContent = isDemoRunning;
            document.getElementById('debug-invoice').textContent = invoiceDownloaded;
        }

        function resetChatWindows() {
            // Reset procurement conversation
            document.getElementById('procurement-conversation').innerHTML = `
                <div class="text-center text-muted py-5">
                    <i class="fas fa-robot fa-3x mb-3"></i>
                    <p>Waiting for conversation to start...</p>
                </div>
            `;
            
            // Reset supplier conversation
            document.getElementById('supplier-conversation').innerHTML = `
                <div class="text-center text-muted py-5">
                    <i class="fas fa-robot fa-3x mb-3"></i>
                    <p>Waiting for conversation to start...</p>
                </div>
            `;
            
            // Reset all counters and flags
            messageCount = 0;
            demoStepCount = 0;
            currentDemoStepCount = 0;
            invoiceDownloaded = false;
            isDemoRunning = false;
            
            // Reset step description
            updateCurrentStep(0);
            
            // Reset debug info
            updateDebugInfo();
            
            // Reset button state
            document.body.classList.remove('demo-running');
            document.getElementById('floating-main-btn').innerHTML = '<i class="fas fa-play me-2"></i>Trigger Scenario';
            document.getElementById('floating-main-btn').disabled = false;
        }

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                console.log('WebSocket connected');
                updateConnectionStatus(true);
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            ws.onclose = function() {
                console.log('WebSocket disconnected');
                updateConnectionStatus(false);
                setTimeout(connectWebSocket, 3000);
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                updateConnectionStatus(false);
            };
        }

        function handleWebSocketMessage(data) {
            if (data.type === 'initial_data') {
                // Don't load event history on page refresh - start fresh
                updateAgentStatus(data.agent_status);
            } else if (data.step_number) {
                addConversationMessage(data);
                updateCurrentStep(data.step_number);
            }
        }

        function addConversationMessage(event) {
            messageCount++;
            demoStepCount++;
            
            // Only increment current demo step count if demo is running
            if (isDemoRunning) {
                currentDemoStepCount++;
            }
            
            updateDebugInfo();
            
            console.log(`Step ${demoStepCount} (Current Demo: ${currentDemoStepCount}): ${event.event_type} from ${event.agent_id}`);
            
            // Determine which agent panel to add the message to
            const agentId = event.agent_id;
            const isProcurement = agentId.includes('procurement');
            
            const conversationId = isProcurement ? 'procurement-conversation' : 'supplier-conversation';
            const conversation = document.getElementById(conversationId);
            
            // Remove "waiting" message if it exists
            const waitingMsg = conversation.querySelector('.text-center');
            if (waitingMsg) {
                waitingMsg.remove();
            }
            
            // Create message element
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isProcurement ? 'sent' : 'received'}`;
            
            const messageType = getMessageType(event.event_type);
            const messageText = formatMessageText(event.description, event.data, event.step_number, isProcurement, event.event_type);
            
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    <div class="d-flex justify-content-between align-items-start">
                        <strong>${messageType}</strong>
                        <small class="opacity-75">${new Date(event.timestamp).toLocaleTimeString()}</small>
                    </div>
                    <div class="mt-2">${messageText}</div>
                    ${event.data && Object.keys(event.data).length > 0 ? `
                        <details class="mt-2">
                            <summary class="text-primary" style="cursor: pointer; font-size: 0.8em;">View Details</summary>
                            <pre class="mt-2 small">${JSON.stringify(event.data, null, 2)}</pre>
                        </details>
                    ` : ''}
                </div>
            `;
            
            conversation.appendChild(messageDiv);
            
            // Show typing indicator briefly
            showTypingIndicator(isProcurement);
            
            // Auto-scroll to bottom
            conversation.scrollTop = conversation.scrollHeight;
            
            // Invoice generation is triggered strictly by 'invoice_generated' backend event
        }

        function generateInvoiceMessage() {
            // Add invoice generation message to supplier conversation
            const conversation = document.getElementById('supplier-conversation');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message received';
            
            const messageText = `
                üßæ <strong>Generating PDF Invoice</strong><br><br>Creating professional PDF invoice for the completed order...<br><br>
                üìÑ <strong>Invoice Details:</strong><br>
                ‚Ä¢ Invoice #: INV-2024-001<br>
                ‚Ä¢ Order #: ORD-2024-001<br>
                ‚Ä¢ Date: ${new Date().toLocaleDateString()}<br>
                ‚Ä¢ Due Date: ${new Date(Date.now() + 30*24*60*60*1000).toLocaleDateString()}<br><br>
                üíæ <strong>PDF invoice generated and downloading to your browser!</strong>
            `;
            
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    <div class="d-flex justify-content-between align-items-start">
                        <strong>üßæ Invoice Generated</strong>
                        <small class="opacity-75">${new Date().toLocaleTimeString()}</small>
                    </div>
                    <div class="mt-2">${messageText}</div>
                </div>
            `;
            
            conversation.appendChild(messageDiv);
            conversation.scrollTop = conversation.scrollHeight;
        }

        function getMessageType(eventType) {
            const types = {
                'discovery': 'üîç Discovery',
                'task_created': 'üìù Task Created',
                'message_sent': 'üì§ Message Sent',
                'message_received': 'üì• Message Received',
                'quote_generated': 'üí∞ Quote Generated',
                'order_placed': 'üì¶ Order Placed',
                'status_update': 'üîÑ Status Update',
                'error': '‚ùå Error',
                'payment_sent': 'üí≥ Payment Sent',
                'payment_received': '‚úÖ Payment Received',
                'invoice_generated': 'üßæ Invoice Generated'
            };
            return types[eventType] || 'ÔøΩÔøΩ Event';
        }

        function formatMessageText(description, data, stepNumber, isProcurement, eventType) {
            let text = '';
            
            // Create clear, layman-friendly messages based on event type and step number
            if (eventType === 'discovery' && description.includes('started and registered')) {
                if (isProcurement) {
                    text = "üöÄ <strong>Starting Up</strong><br><br>I'm turning on and connecting to the A2A network. This is like me logging into a special system where I can find and talk to other AI agents.";
                } else {
                    text = "üöÄ <strong>Starting Up</strong><br><br>I'm turning on and connecting to the A2A network. This is like me logging into a special system where I can find and talk to other AI agents.";
                }
            } else if (eventType === 'task_created' && description.includes('Purchase Request')) {
                text = "‚ö†Ô∏è <strong>LOW STOCK ALERT!</strong><br><br>";
                currentInventory.forEach((item, index) => {
                    if (item.currentStock <= item.minThreshold) {
                        text += `<div class="low-stock-item">${item.name}: ${item.currentStock} ${item.unit} remaining (MIN: ${item.minThreshold})</div>`;
                    }
                });
                text += "<br>üö® <strong>Action Required:</strong> I need to place an order immediately to restock these critical supplies!";
            } else if (eventType === 'task_created' && description.includes('Created purchase request')) {
                text = "üìã <strong>Creating Emergency Purchase Request</strong><br><br>Based on the low stock alert, I'm creating a purchase request for the supplies we need most urgently.<br><br>";
                text += "üõí <strong>Here's What We Need to Order:</strong><br><br>";
                officeSupplies.forEach((item, index) => {
                    text += `<span class="product-item">${item.quantity} ${item.name}</span><br>`;
                });
                text += "<br>üìù <strong>Order Details:</strong><br>";
                text += "‚Ä¢ Department: Office Administration<br>";
                text += "‚Ä¢ Priority: URGENT (Low Stock)<br>";
                text += "‚Ä¢ Budget: $100.00<br>";
                text += "‚Ä¢ Delivery: Within 5 business days";
            } else if (eventType === 'discovery' && description.includes('Discovered 0 agents')) {
                text = "üîç <strong>Searching for Suppliers</strong><br><br>I'm searching the A2A network to find suppliers who can quickly provide these office supplies. Time is critical!<br><br>";
                text += "‚ö†Ô∏è <strong>No suppliers found in initial search.</strong> Let me try a broader search...";
            } else if (eventType === 'status_update' && description.includes('capabilities initialized')) {
                text = "üîÑ <strong>System Ready</strong><br><br>All my capabilities are now initialized and ready. I can monitor inventory, create purchase requests, evaluate quotes, and place orders automatically.";
            } else if (eventType === 'payment_sent') {
                const amount = (data && (data.amount || data.total_amount)) ? (data.amount || data.total_amount) : 0;
                const orderId = data && data.order_id ? data.order_id : 'N/A';
                text = `üí≥ <strong>Payment Sent</strong><br><br>I have paid the supplier for the order.<br><br>` +
                       `üì¶ <strong>Order ID:</strong> ${orderId}<br>` +
                       `üíµ <strong>Amount:</strong> $${Number(amount).toFixed(2)}<br><br>` +
                       `‚è≥ Waiting for the supplier to confirm receipt...`;
            } else if (eventType === 'payment_received') {
                const amount = (data && (data.amount || data.total_amount)) ? (data.amount || data.total_amount) : 0;
                const orderId = data && data.order_id ? data.order_id : 'N/A';
                text = `‚úÖ <strong>Payment Confirmed</strong><br><br>We've received the payment in full and the order is now fully paid and being fulfilled.<br><br>` +
                       `üì¶ <strong>Order ID:</strong> ${orderId}<br>` +
                       `üíµ <strong>Amount Received:</strong> $${Number(amount).toFixed(2)}<br><br>` +
                       `üßæ Generating the invoice now...`;
            } else if (eventType === 'invoice_generated') {
                const amount = (data && (data.amount || data.total_amount)) ? (data.amount || data.total_amount) : 0;
                const orderId = data && data.order_id ? data.order_id : 'N/A';
                text = `üßæ <strong>Invoice Generated</strong><br><br>The invoice has been generated and downloaded to your browser.<br><br>` +
                       `üì¶ <strong>Order ID:</strong> ${orderId}<br>` +
                       `üíµ <strong>Total Amount:</strong> $${Number(amount).toFixed(2)}<br><br>` +
                       `üéâ <strong>Payment Complete:</strong> This purchase is now fully paid and closed.`;
            } else {
                // Fallback to original description
                text = description || "Processing...";
            }
            
            return text;
        }

        function generatePDFInvoice() {
            try {
                console.log('Starting PDF generation...');
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Company header
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text('Office Supply Co.', 20, 30);
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text('123 Business Street, Suite 100', 20, 40);
                doc.text('City, State 12345', 20, 45);
                doc.text('Phone: (555) 123-4567', 20, 50);
                doc.text('Email: billing@officesupplyco.com', 20, 55);
                
                // Invoice title
                doc.setFontSize(24);
                doc.setFont(undefined, 'bold');
                doc.text('INVOICE', 150, 30);
                
                // Invoice details
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text('Invoice #: INV-2024-001', 150, 40);
                doc.text('Order #: ORD-2024-001', 150, 45);
                doc.text('Date: ' + new Date().toLocaleDateString(), 150, 50);
                doc.text('Due Date: ' + new Date(Date.now() + 30*24*60*60*1000).toLocaleDateString(), 150, 55);
                
                // Bill to section
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Bill To:', 20, 75);
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text('Procurement Department', 20, 85);
                doc.text('Company Name', 20, 90);
                doc.text('456 Corporate Avenue', 20, 95);
                doc.text('City, State 12345', 20, 100);
                
                // Table header
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('Description', 20, 120);
                doc.text('Qty', 120, 120);
                doc.text('Unit Price', 140, 120);
                doc.text('Total', 170, 120);
                
                // Draw line under header
                doc.line(20, 125, 190, 125);
                
                // Table rows
                let yPosition = 135;
                let subtotal = 0;
                
                officeSupplies.forEach((item, index) => {
                    const quantity = parseInt(item.quantity);
                    const total = item.price;
                    subtotal += total;
                    
                    doc.setFont(undefined, 'normal');
                    doc.text(item.name, 20, yPosition);
                    doc.text(quantity.toString(), 120, yPosition);
                    doc.text('$' + item.price.toFixed(2), 140, yPosition);
                    doc.text('$' + total.toFixed(2), 170, yPosition);
                    
                    yPosition += 8;
                });
                
                // Totals section
                yPosition += 10;
                doc.line(20, yPosition, 190, yPosition);
                yPosition += 10;
                
                doc.setFont(undefined, 'bold');
                doc.text('Subtotal:', 150, yPosition);
                doc.text('$' + subtotal.toFixed(2), 170, yPosition);
                yPosition += 8;
                
                const tax = subtotal * 0.085;
                doc.text('Tax (8.5%):', 150, yPosition);
                doc.text('$' + tax.toFixed(2), 170, yPosition);
                yPosition += 8;
                
                doc.setFontSize(12);
                const grandTotal = subtotal + tax;
                doc.text('Total:', 150, yPosition);
                doc.text('$' + grandTotal.toFixed(2), 170, yPosition);
                
                // Payment terms
                yPosition += 20;
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('Payment Terms:', 20, yPosition);
                doc.setFont(undefined, 'normal');
                doc.text('Net 30 days', 20, yPosition + 8);
                doc.text('Delivery: 2-3 business days', 20, yPosition + 16);
                
                // Footer
                yPosition += 30;
                doc.setFontSize(10);
                doc.setFont(undefined, 'italic');
                doc.text('Thank you for your business!', 20, yPosition);
                doc.text('Generated by A2A Agent Protocol', 20, yPosition + 8);
                
                // Save the PDF
                doc.save('Invoice_INV-2024-001.pdf');
                console.log('PDF invoice generated successfully');
            } catch (error) {
                console.error('Error generating PDF invoice:', error);
            }
        }

        function showTypingIndicator(isProcurement) {
            const typingId = isProcurement ? 'procurement-typing' : 'supplier-typing';
            const typing = document.getElementById(typingId);
            
            typing.classList.add('show');
            setTimeout(() => {
                typing.classList.remove('show');
            }, 2000);
        }

        function updateCurrentStep(stepNumber) {
            currentStep = stepNumber;
            
            const stepTexts = [
                'Ready to start the demo. Click the floating "Trigger Scenario" button to begin watching the agents interact!',
                'Both agents are starting up and connecting to the A2A network.',
                'The Procurement Agent is monitoring inventory levels to detect low stock.',
                'The Procurement Agent has detected low stock levels and is creating an urgent purchase request.',
                'The Procurement Agent is creating an emergency purchase request for low stock items.',
                'The Procurement Agent is identifying the specific office supplies needed for the urgent purchase.',
                'The Procurement Agent is searching for suppliers who can quickly provide these supplies.',
                'The Procurement Agent is asking the supplier for an urgent quote.',
                'The Supplier Agent has received the urgent quote request and is checking inventory.',
                'The Supplier Agent is checking what office supplies are available in stock.',
                'The Supplier Agent is creating a detailed price quote with costs and delivery info.',
                'The Procurement Agent is reviewing the quote and negotiating for a better price.',
                'The Procurement Agent is negotiating a 10% discount to bring the total within budget.',
                'The Procurement Agent is placing the order with the negotiated price.',
                'The Supplier Agent is processing the order and updating inventory records.',
                'The Supplier Agent is generating a professional PDF invoice that will be automatically downloaded to your browser.'
            ];
            
            const stepText = stepTexts[Math.min(stepNumber, stepTexts.length - 1)];
            document.getElementById('step-text').textContent = stepText;
        }

        function updateAgentStatus(agentStatus) {
            Object.keys(agentStatus).forEach(agentId => {
                const status = agentStatus[agentId];
                const statusElement = document.getElementById(agentId.replace('_', '-') + '-status');
                if (statusElement) {
                    statusElement.textContent = status.status === 'active' ? 'Active' : 'Error';
                    statusElement.className = `agent-status ${status.status === 'active' ? 'status-active' : 'status-error'}`;
                }
            });
        }

        function loadEventHistory(events) {
            events.forEach(event => {
                addConversationMessage(event);
                updateCurrentStep(event.step_number);
            });
        }

        function updateConnectionStatus(connected) {
            // Update connection status if needed
        }

        function startSlowDemo() {
            if (isDemoRunning) return;
            
            isDemoRunning = true;
            invoiceDownloaded = false; // Reset invoice download flag
            currentDemoStepCount = 0; // Reset current demo step counter
            updateDebugInfo();
            updateCurrentStep(1);
            
            // Update floating button state
            document.body.classList.add('demo-running');
            document.getElementById('floating-main-btn').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Demo Running...';
            document.getElementById('floating-main-btn').disabled = true;
            
            // Scroll to agents
            scrollToAgents();
            
            fetch('/api/start-demo', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    console.log('Slow demo started:', data);
                    
                    // Reset button after demo completes (estimate 30 seconds)
                    setTimeout(() => {
                        isDemoRunning = false;
                        document.body.classList.remove('demo-running');
                        document.getElementById('floating-main-btn').innerHTML = '<i class="fas fa-play me-2"></i>Trigger Scenario';
                        document.getElementById('floating-main-btn').disabled = false;
                        updateDebugInfo();
                    }, 30000);
                })
                .catch(error => {
                    console.error('Error starting slow demo:', error);
                    isDemoRunning = false;
                    document.body.classList.remove('demo-running');
                    document.getElementById('floating-main-btn').innerHTML = '<i class="fas fa-play me-2"></i>Trigger Scenario';
                    document.getElementById('floating-main-btn').disabled = false;
                    updateDebugInfo();
                });
        }

        function clearConversation() {
            resetChatWindows();
        }

        function scrollToAgents() {
            document.getElementById('agent-panels').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }

        // Show/hide scroll to top button
        window.addEventListener('scroll', function() {
            const scrollBtn = document.getElementById('scroll-to-top');
            if (window.pageYOffset > 300) {
                scrollBtn.classList.add('show');
            } else {
                scrollBtn.classList.remove('show');
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Reset chat windows on page load/refresh
            resetChatWindows();
            connectWebSocket();
        });
    </script>
</body>
</html>
