<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disco A2A Agent Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --brand-primary: #00e3a2;
            --brand-secondary: #6c5ce7;
            --brand-bg: #1a1a2e;
            --brand-text: #ffffff;
            --brand-accent: #ff6b6b;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: var(--brand-text);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        .navbar {
            background: rgba(26, 26, 46, 0.95) !important;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 227, 162, 0.3);
        }

        .navbar-brand {
            color: var(--brand-primary) !important;
            font-weight: bold;
            font-size: 1.5rem;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .card-header {
            background: rgba(0, 227, 162, 0.1);
            border-bottom: 1px solid rgba(0, 227, 162, 0.3);
            border-radius: 15px 15px 0 0 !important;
        }

        .card-title {
            color: var(--brand-primary);
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--brand-primary), var(--brand-secondary));
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 227, 162, 0.4);
        }

        .btn-success {
            background: linear-gradient(45deg, #00b894, #00cec9);
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 600;
        }

        .btn-danger {
            background: linear-gradient(45deg, #e17055, #d63031);
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 600;
        }

        .timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, var(--brand-primary), var(--brand-secondary));
        }

        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }

        .timeline-marker {
            position: absolute;
            left: -22px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--brand-primary);
            border: 3px solid var(--brand-bg);
        }

        .timeline-marker.success {
            background: #00b894;
        }

        .timeline-marker.error {
            background: #e17055;
        }

        .timeline-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-left: 10px;
        }

        .agent-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-active {
            background: rgba(0, 184, 148, 0.2);
            color: #00b894;
            border: 1px solid #00b894;
        }

        .status-error {
            background: rgba(225, 112, 85, 0.2);
            color: #e17055;
            border: 1px solid #e17055;
        }

        .step-counter {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--brand-primary);
            text-shadow: 0 0 20px rgba(0, 227, 162, 0.5);
        }

        .progress {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(45deg, var(--brand-primary), var(--brand-secondary));
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .completion-banner {
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
            animation: slideDown 0.5s ease-out;
        }

        .completion-banner.show {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .completion-success {
            background: linear-gradient(135deg, rgba(0, 184, 148, 0.2), rgba(0, 206, 201, 0.2)) !important;
            border: 2px solid #00b894 !important;
        }

        .timeline-container {
            max-height: 400px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--brand-primary) rgba(255, 255, 255, 0.1);
        }

        .timeline-container::-webkit-scrollbar {
            width: 6px;
        }

        .timeline-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .timeline-container::-webkit-scrollbar-thumb {
            background: var(--brand-primary);
            border-radius: 3px;
        }

        .timeline-empty {
            text-align: center;
            padding: 40px 20px;
            color: rgba(255, 255, 255, 0.6);
        }

        .message-log {
            max-height: 300px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--brand-primary) rgba(255, 255, 255, 0.1);
        }

        .message-log::-webkit-scrollbar {
            width: 6px;
        }

        .message-log::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .message-log::-webkit-scrollbar-thumb {
            background: var(--brand-primary);
            border-radius: 3px;
        }

        .badge {
            font-size: 0.75rem;
            padding: 4px 8px;
        }

        .form-check-input:checked {
            background-color: var(--brand-primary);
            border-color: var(--brand-primary);
        }

        .form-check-input:focus {
            box-shadow: 0 0 0 0.25rem rgba(0, 227, 162, 0.25);
        }

        .timestamp {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
        }

        .agent-name, .event-type {
            color: var(--brand-primary);
        }

        .text-primary {
            color: var(--brand-primary) !important;
        }

        .text-success {
            color: #00b894 !important;
        }

        .text-danger {
            color: #e17055 !important;
        }

        .bg-success {
            background-color: #00b894 !important;
        }

        .bg-danger {
            background-color: #e17055 !important;
        }

        .border-bottom {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        .pb-2 {
            padding-bottom: 0.5rem !important;
        }

        .mb-2 {
            margin-bottom: 0.5rem !important;
        }

        .mb-1 {
            margin-bottom: 0.25rem !important;
        }

        .mb-0 {
            margin-bottom: 0 !important;
        }

        .mt-2 {
            margin-top: 0.5rem !important;
        }

        .py-4 {
            padding-top: 1.5rem !important;
            padding-bottom: 1.5rem !important;
        }

        .small {
            font-size: 0.875rem;
        }

        .fa-2x {
            font-size: 2em;
        }

        .fa-spin {
            animation: fa-spin 1s infinite linear;
        }

        @keyframes fa-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .d-flex {
            display: flex !important;
        }

        .justify-content-between {
            justify-content: space-between !important;
        }

        .justify-content-center {
            justify-content: center !important;
        }

        .align-items-start {
            align-items: flex-start !important;
        }

        .align-items-center {
            align-items: center !important;
        }

        .text-center {
            text-align: center !important;
        }

        .text-muted {
            color: rgba(255, 255, 255, 0.6) !important;
        }

        .me-1 {
            margin-right: 0.25rem !important;
        }

        .me-2 {
            margin-right: 0.5rem !important;
        }
    </style>
</head>
<body>
    <!-- Completion Banner -->
    <div id="completion-banner" class="completion-banner">
        <h3><i class="fas fa-check-circle me-2"></i>Transaction Completed Successfully!</h3>
        <p class="mb-2">Your office supply order has been processed, payment received, and invoice generated.</p>
        <div class="row">
            <div class="col-md-4">
                <strong>Tasks Completed:</strong> <span id="completion-tasks">0</span>
            </div>
            <div class="col-md-4">
                <strong>Total Time:</strong> <span id="completion-time">0s</span>
            </div>
            <div class="col-md-4">
                <strong>Status:</strong> <span class="text-success">Invoice Generated</span>
            </div>
        </div>
    </div>

    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-robot me-2"></i>Disco A2A Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <span id="connection-status" class="badge bg-success">
                    <i class="fas fa-circle me-1"></i>Connected
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Left Sidebar -->
            <div class="col-md-3">
                <!-- Controls -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-play-circle me-2"></i>Controls
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="startDemo()">
                                <i class="fas fa-play me-2"></i>Start Demo
                            </button>
                            <button class="btn btn-danger" onclick="resetDemo()">
                                <i class="fas fa-refresh me-2"></i>Reset
                            </button>
                        </div>
                        <div class="mt-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="auto-scroll" checked>
                                <label class="form-check-label" for="auto-scroll">
                                    Auto-scroll timeline
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="sound-alerts" checked>
                                <label class="form-check-label" for="sound-alerts">
                                    Sound alerts
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Agent Status -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-users me-2"></i>Agent Status
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="agent-status">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Procurement Agent</span>
                                <span class="agent-status status-active" id="proc-status">Active</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Supplier Agent</span>
                                <span class="agent-status status-active" id="supp-status">Active</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Current Step -->
                <div class="card mb-4" id="current-step-card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-play-circle me-2"></i>Current Step
                        </h5>
                    </div>
                    <div class="card-body text-center">
                        <div class="step-counter" id="current-step">0</div>
                        <div class="progress mt-2">
                            <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted" id="step-description">Waiting for agents to start...</small>
                    </div>
                </div>

                <!-- Performance Statistics -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-line me-2"></i>Performance
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <h4 class="text-primary" id="tasks-completed">0</h4>
                                <small class="text-muted">Tasks Completed</small>
                            </div>
                            <div class="col-6">
                                <h4 class="text-success" id="total-time">0s</h4>
                                <small class="text-muted">Total Time</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Timeline -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-timeline me-2"></i>Transaction Timeline
                        </h5>
                        <span class="badge bg-primary" id="timeline-count">0 events</span>
                    </div>
                    <div class="card-body p-0">
                        <div id="timeline-container" class="timeline-container">
                            <div id="timeline" class="timeline p-3">
                                <div class="timeline-empty">
                                    <i class="fas fa-clock fa-2x mb-2"></i>
                                    <p>Waiting for agent interactions...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Messages -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-comments me-2"></i>Message Log
                        </h5>
                        <span class="badge bg-info" id="message-count">0 messages</span>
                    </div>
                    <div class="card-body p-0">
                        <div id="message-log" class="message-log p-3">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-comment-slash fa-2x mb-2"></i>
                                <p>No messages yet...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let ws;
        let currentStep = 0;
        let totalSteps = 50;
        let messageCount = 0;
        let demoStartTime = null;
        let demoEndTime = null;
        let isDemoComplete = false;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                console.log('WebSocket connected');
                updateConnectionStatus(true);
                reconnectAttempts = 0;
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            ws.onclose = function() {
                console.log('WebSocket disconnected');
                updateConnectionStatus(false);
                
                // Attempt to reconnect
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    console.log(`Attempting to reconnect... (${reconnectAttempts}/${maxReconnectAttempts})`);
                    setTimeout(connectWebSocket, 3000);
                }
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                updateConnectionStatus(false);
            };
        }

        function handleWebSocketMessage(data) {
            if (data.type === 'initial_data') {
                // Load initial data
                loadEventHistory(data.event_history);
                updateAgentStatus(data.agent_status);
                updateStatistics(data);
            } else if (data.type === 'demo_reset') {
                // Handle demo reset from server
                console.log('Demo reset received from server');
                resetDashboard();
            } else if (data.step_number) {
                // New event
                addTimelineEvent(data);
                updateCurrentStep(data.step_number);
                addMessageLog(data);
                updateStatistics();
                
                // Check if demo is complete
                checkDemoCompletion();
                
                // Play sound alert if enabled
                if (document.getElementById('sound-alerts').checked) {
                    playNotificationSound();
                }
            } else if (data.type === 'status_update') {
                updateAgentStatus(data.agent_status);
                updateStatistics(data);
            }
        }

        function checkDemoCompletion() {
            // Check if we have all the key completion events
            const timeline = document.getElementById('timeline');
            const events = timeline.querySelectorAll('.timeline-item');
            
            let hasOrder = false;
            let hasPaymentSent = false;
            let hasPaymentReceived = false;
            let hasInvoice = false;
            
            console.log('Checking demo completion...');
            console.log('Total events found:', events.length);
            
            events.forEach(event => {
                const eventTypeElement = event.querySelector('.event-type');
                if (eventTypeElement) {
                    const eventType = eventTypeElement.textContent.toLowerCase().replace(/\s+/g, '_');
                    console.log('Found event type:', eventType);
                    
                    if (eventType === 'order_placed') {
                        hasOrder = true;
                        console.log('‚úì Order placed found');
                    }
                    if (eventType === 'payment_sent') {
                        hasPaymentSent = true;
                        console.log('‚úì Payment sent found');
                    }
                    if (eventType === 'payment_received') {
                        hasPaymentReceived = true;
                        console.log('‚úì Payment received found');
                    }
                    if (eventType === 'invoice_generated') {
                        hasInvoice = true;
                        console.log('‚úì Invoice generated found');
                    }
                }
            });
            
            console.log('Completion status:', {
                hasOrder,
                hasPaymentSent,
                hasPaymentReceived,
                hasInvoice,
                isDemoComplete
            });
            
            // Demo is complete when we have all key events
            if (hasOrder && hasPaymentSent && hasPaymentReceived && hasInvoice && !isDemoComplete) {
                console.log('üéâ Demo completed! Stopping timer...');
                isDemoComplete = true;
                demoEndTime = new Date();
                console.log('Demo completed! Final time:', demoEndTime - demoStartTime, 'ms');
                
                // Show completion banner
                showCompletionBanner();
                
                // Update step description to show completion
                document.getElementById('step-description').textContent = 'Transaction completed successfully!';
                
                // Style the current step card to show completion
                const currentStepCard = document.getElementById('current-step-card');
                currentStepCard.classList.add('completion-success');
            }
        }

        function showCompletionBanner() {
            const banner = document.getElementById('completion-banner');
            const completedTasks = document.getElementById('tasks-completed').textContent;
            const totalTime = document.getElementById('total-time').textContent;
            
            // Update banner stats
            document.getElementById('completion-tasks').textContent = completedTasks;
            document.getElementById('completion-time').textContent = totalTime;
            
            // Show the banner with animation
            banner.style.display = 'block';
            
            // Scroll to top to show the banner
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function getEventDescription(event) {
            // Provide more meaningful descriptions for specific event types
            const eventType = event.event_type;
            const data = event.data || {};
            
            switch (eventType) {
                case 'payment_sent':
                    return `üí≥ Payment sent for order ${data.order_id || 'N/A'}: $${data.amount || 0}`;
                case 'payment_received':
                    return `üí∞ Payment received for order ${data.order_id || 'N/A'}: $${data.amount || 0}`;
                case 'invoice_generated':
                    return `üìÑ Invoice ${data.invoice_id || 'N/A'} generated for order ${data.order_id || 'N/A'}: $${data.total_amount || 0}`;
                case 'order_placed':
                    return `üì¶ Order ${data.order_id || 'N/A'} placed for $${data.total_amount || 0}`;
                case 'quote_generated':
                    return `üíµ Quote ${data.quote_id || 'N/A'} generated: $${data.total_amount || 0}`;
                case 'message_sent':
                    return `üì§ Message sent to ${event.agent_id.replace('_', ' ')}`;
                case 'message_received':
                    return `üì• Message received from ${event.agent_id.replace('_', ' ')}`;
                case 'task_created':
                    return `üìã Task created: ${data.task_name || 'New task'}`;
                case 'discovery':
                    return `üîç Agent discovery: ${event.agent_id.replace('_', ' ')} registered`;
                case 'status_update':
                    return `üîÑ Status update: ${event.agent_id.replace('_', ' ')}`;
                default:
                    return event.description || `Event: ${eventType.replace('_', ' ')}`;
            }
        }

        function getEventIcon(event) {
            // Provide appropriate icons for different event types
            const eventType = event.event_type;
            
            switch (eventType) {
                case 'payment_sent':
                case 'payment_received':
                    return 'üí≥';
                case 'invoice_generated':
                    return 'üìÑ';
                case 'order_placed':
                    return 'üì¶';
                case 'quote_generated':
                    return 'üíµ';
                case 'message_sent':
                    return 'üì§';
                case 'message_received':
                    return 'üì•';
                case 'task_created':
                    return 'üìã';
                case 'discovery':
                    return 'üîç';
                case 'status_update':
                    return 'üîÑ';
                default:
                    return 'üìù';
            }
        }

        function addTimelineEvent(event) {
            const timeline = document.getElementById('timeline');
            const timelineContainer = document.getElementById('timeline-container');
            
            // Remove "waiting" message if it exists
            const waitingMsg = timeline.querySelector('.timeline-empty');
            if (waitingMsg) {
                waitingMsg.remove();
            }
            
            const eventDiv = document.createElement('div');
            eventDiv.className = 'timeline-item event-card';
            
            // Get enhanced description and icon
            const description = getEventDescription(event);
            const icon = getEventIcon(event);
            
            eventDiv.innerHTML = `
                <div class="timeline-marker ${event.success ? 'success' : 'error'}"></div>
                <div class="timeline-card">
                    <div class="d-flex justify-content-between align-items-start">
                        <h6 class="card-title">${icon} Step ${event.step_number}: ${description}</h6>
                        <small class="timestamp">${new Date(event.timestamp).toLocaleTimeString()}</small>
                    </div>
                    <p class="card-text mb-1">
                        <strong class="agent-name">Agent:</strong> ${event.agent_id.replace('_', ' ').toUpperCase()}
                    </p>
                    <p class="card-text mb-0">
                        <strong class="event-type">Type:</strong> ${event.event_type.replace('_', ' ').toUpperCase()}
                    </p>
                    ${event.data && Object.keys(event.data).length > 0 ? `
                        <details class="mt-2">
                            <summary class="text-primary" style="cursor: pointer;">View Details</summary>
                            <pre class="mt-2 small" style="background: var(--brand-bg); padding: 8px; border-radius: 4px; color: var(--brand-text);">${JSON.stringify(event.data, null, 2)}</pre>
                        </details>
                    ` : ''}
                </div>
            `;
            
            timeline.appendChild(eventDiv);
            
            // Update timeline count
            const timelineCount = document.getElementById('timeline-count');
            timelineCount.textContent = `${timeline.children.length} events`;
            
            // Auto-scroll within the container if enabled
            if (document.getElementById('auto-scroll').checked) {
                timelineContainer.scrollTop = timelineContainer.scrollHeight;
            }
        }

        function addMessageLog(event) {
            const messageLog = document.getElementById('message-log');
            
            // Remove "no messages" message if it exists
            const noMsgDiv = messageLog.querySelector('.text-center');
            if (noMsgDiv) {
                noMsgDiv.remove();
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'border-bottom pb-2 mb-2';
            messageDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <strong class="text-primary">${event.agent_id.replace('_', ' ')}</strong>
                    <small class="text-muted">${new Date(event.timestamp).toLocaleTimeString()}</small>
                </div>
                <p class="mb-1 small">${getEventDescription(event)}</p>
                <span class="badge ${event.success ? 'bg-success' : 'bg-danger'}">${event.event_type}</span>
            `;
            
            messageLog.insertBefore(messageDiv, messageLog.firstChild);
            messageCount++;
            
            // Update message count
            const messageCountEl = document.getElementById('message-count');
            messageCountEl.textContent = `${messageCount} messages`;
            
            // Keep only last 20 messages
            while (messageLog.children.length > 20) {
                messageLog.removeChild(messageLog.lastChild);
            }
        }

        function updateCurrentStep(stepNumber) {
            currentStep = stepNumber;
            document.getElementById('current-step').textContent = stepNumber;
            
            const progress = Math.min((stepNumber / totalSteps) * 100, 100);
            document.getElementById('progress-bar').style.width = progress + '%';
            
            // Update step description
            const descriptions = [
                'Waiting for agents to start...',
                'Agent discovery and registration',
                'Creating purchase request',
                'Sending quote request to supplier',
                'Supplier checking inventory',
                'Generating quote and pricing',
                'Evaluating quote and making decision',
                'Placing order with supplier',
                'Processing order and confirmation',
                'Order shipped with tracking',
                'Delivery completed'
            ];
            
            const description = descriptions[Math.min(stepNumber, descriptions.length - 1)];
            document.getElementById('step-description').textContent = description;
        }

        function updateAgentStatus(agentStatus) {
            // Update agent status indicators
            Object.keys(agentStatus).forEach(agentId => {
                const status = agentStatus[agentId];
                const statusElement = document.getElementById(agentId.replace('_', '-') + '-status');
                if (statusElement) {
                    statusElement.textContent = status.status === 'active' ? 'Active' : 'Error';
                    statusElement.className = `agent-status ${status.status === 'active' ? 'status-active' : 'status-error'}`;
                }
            });
        }

        function updateStatistics(data = null) {
            // Count completed tasks based on event types
            const completedTaskTypes = ['order_placed', 'payment_sent', 'payment_received', 'invoice_generated'];
            const timeline = document.getElementById('timeline');
            const events = timeline.querySelectorAll('.timeline-item');
            
            let completedTasks = 0;
            events.forEach(event => {
                const eventType = event.querySelector('.event-type').textContent.toLowerCase().replace(/\s+/g, '_');
                if (completedTaskTypes.includes(eventType)) {
                    completedTasks++;
                }
            });
            
            // Update tasks completed
            document.getElementById('tasks-completed').textContent = completedTasks;
            
            // Calculate total time
            if (demoStartTime) {
                let elapsedSeconds;
                if (isDemoComplete && demoEndTime) {
                    // Demo is complete, use final time
                    elapsedSeconds = Math.floor((demoEndTime - demoStartTime) / 1000);
                    console.log('Timer stopped - using final time:', elapsedSeconds, 'seconds');
                } else {
                    // Demo is running, use current time
                    const currentTime = new Date();
                    elapsedSeconds = Math.floor((currentTime - demoStartTime) / 1000);
                }
                document.getElementById('total-time').textContent = `${elapsedSeconds}s`;
            }
        }

        function loadEventHistory(events) {
            events.forEach(event => {
                addTimelineEvent(event);
                updateCurrentStep(event.step_number);
            });
            updateStatistics();
        }

        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connection-status');
            if (connected) {
                statusElement.innerHTML = '<i class="fas fa-circle me-1"></i>Connected';
                statusElement.className = 'badge bg-success';
            } else {
                statusElement.innerHTML = '<i class="fas fa-circle me-1"></i>Disconnected';
                statusElement.className = 'badge bg-danger';
            }
        }

        function playNotificationSound() {
            // Create a simple notification sound
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.2);
        }

        function startDemo() {
            // Hide completion banner if visible
            document.getElementById('completion-banner').style.display = 'none';
            
            // Record demo start time
            demoStartTime = new Date();
            demoEndTime = null;
            isDemoComplete = false;
            
            console.log('Demo started at:', demoStartTime);
            
            // Reset current step card styling
            const currentStepCard = document.getElementById('current-step-card');
            currentStepCard.classList.remove('completion-success');
            
            fetch('/api/start-demo', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        console.log('Demo started:', data.message);
                    } else {
                        console.error('Error starting demo:', data.message);
                    }
                })
                .catch(error => console.error('Error starting demo:', error));
        }

        function resetDemo() {
            console.log('Resetting demo...');
            
            // Call the reset API endpoint
            fetch('/api/reset-demo', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        console.log('Demo reset successfully:', data.message);
                        resetDashboard();
                    } else {
                        console.error('Error resetting demo:', data.message);
                        // Still reset the frontend even if API call fails
                        resetDashboard();
                    }
                })
                .catch(error => {
                    console.error('Error calling reset API:', error);
                    // Still reset the frontend even if API call fails
                    resetDashboard();
                });
        }

        function resetDashboard() {
            // Hide completion banner
            document.getElementById('completion-banner').style.display = 'none';
            
            // Reset demo timing
            demoStartTime = null;
            demoEndTime = null;
            isDemoComplete = false;
            
            console.log('Dashboard reset');
            
            // Reset current step card styling
            const currentStepCard = document.getElementById('current-step-card');
            currentStepCard.classList.remove('completion-success');
            
            // Reset the dashboard
            document.getElementById('timeline').innerHTML = `
                <div class="timeline-empty">
                    <i class="fas fa-clock fa-2x mb-2"></i>
                    <p>Waiting for agent interactions...</p>
                </div>
            `;
            document.getElementById('message-log').innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-comment-slash fa-2x mb-2"></i>
                    <p>No messages yet...</p>
                </div>
            `;
            document.getElementById('timeline-count').textContent = '0 events';
            document.getElementById('message-count').textContent = '0 messages';
            messageCount = 0;
            updateCurrentStep(0);
            
            // Reset statistics
            document.getElementById('tasks-completed').textContent = '0';
            document.getElementById('total-time').textContent = '0s';
        }

        function refreshStatus() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'get_status' }));
            }
        }

        // Update time every second when demo is running (but not when complete)
        setInterval(() => {
            if (demoStartTime && !isDemoComplete) {
                updateStatistics();
            }
        }, 1000);

        // Send ping every 30 seconds to keep connection alive
        setInterval(() => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'ping' }));
            }
        }, 30000);

        // Initialize and auto-reset on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-reset the dashboard when page loads/refreshes
            resetDemo();
            connectWebSocket();
        });
    </script>
</body>
</html>
